---
title: "Factors leading to an Approved TSA Claim"
author: "Samba Diallo, David Jia, Raquel Figueroa"
date: "5/13/2018"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(prompt=TRUE, comment="", echo=TRUE)
library(rpart)
library(rpart.plot)
dat = read.csv("https://raw.githubusercontent.com/RaquelFigueroa/tsa_claims/master/tsa_claims.csv")
```

## Project Introduction

For this project, we are investigating property and injury claims filed with the Terminal Security Agency (TSA). We hope to determine patterns and correlations between claims made at airports across the United States...[TODO]


## Project Data

The TSA claims dataset we are using is composed of 204,267 rows and 13 columns. There are many empty values so it will be assumed that many of the rows will be discarded depending on what sorts of features will be used for model creation and data exploration.

This dataset may be found at the link below:
https://www.kaggle.com/terminal-security-agency/tsa-claims-database/data


## Initial data exploration
It should be noted that running the `complete.cases()` function and counting the total number of complete rows showed that all rows are complete. This means that there are no `NA` values, but through the `summary()` function we can see that there are other values to be aware of. There are a notable number of empty string values, dashes ('-'), and the value `Other`. To avoid unintentionally skewing results, these values will need to be discarded or imputed.

***

Another helpful starting function is `str()`.
Through this function, we can see that all features are factors.

We can also determine that there are 204267 rows of data and 13 features.
One interesting feature is `Claim.Number` as it would be assumed that there should be a unique number for each of the unique rows of data. There are 23 less unique claim numbers than there are rows. This could mean that some of the claims needed to be resubmitted and this should be investigated further to ensure some data is not counted more than once.

The data features are as follows:

* Continuous Features
    + Claim.Amount
    + Close.Amount
    
* Categorical Features
    + Claim.Number
    + Date.Received
    + Incident.Date
    + Airport.Code
    + Airport.Name
    + Airline.Name
    + Claim.Type
    + Claim.Site
    + Item
    + Status
    + Disposition

***

## Data Cleaning and Preprocessing

While exploring the data, we determined that many of the empty string values or dashes will either need to be deleted or imputed with values from other columns of the same row. For example, if a row had an empty `Status` value but a `Disposition` value of "Denied" then the value of `Status` was set to equal that of `Disposition`. If both `Status` and Disposition` were empty, then a final action could not be confidently determined and those rows were deleted from the dataset.

The dollar amounts for `Claim.Amount` and `Close.Amount` used characters that made them unusable. The dollar amounts were processed to look like double values so they may be visualizaed later in the project.

There are some rows in the dataset that did not contain data but information about the dataset instead. These rows were deleted to prevent any future errors when exploring the data.

There were also some very large `Claim.Amount` values that belonged to claimes that were denied. Any `Claim.Amount` value greater than `150000.00` was deleted from the data set.

After the dataset is cleaned and preprocessed, `86,285` rows remain.
```{r, echo=TRUE}
# Delete rows with anomalous formats
glitchRows = c(186743,97232,145145,186744,195600)
dat = dat[-glitchRows,]

# Delete rows where Airport.Code and Airport.Name have values "" or "-":
keepRows = dat$Airport.Code != "" & dat$Airport.Code != "-" & dat$Airport.Name != "" & dat$Airport.Name != "-"
dat = dat[keepRows,]

# Delete rows where Airline.Name  has value of "" or "-":
keepRows = dat$Airline.Name != "" & dat$Airline.Name != "-"
dat = dat[keepRows,]

# Delete rows where Claim.Type  has value of "" or "-":
keepRows = dat$Claim.Type != "" & dat$Claim.Type != "-"
dat = dat[keepRows,]

# Delete rows where Claim.Site  has value of "", "-", or "Other:
keepRows = dat$Claim.Site != "" & dat$Claim.Site != "-" & dat$Claim.Site != "Other"
dat = dat[keepRows,]

# Delete rows where Item  has value of "", "-", or "Other:
keepRows = dat$Item != "" & dat$Item != "-" & dat$Item != "Other"
dat = dat[keepRows,]

# Make sure all similar variants of Status values are consolidated and delete values not applicable
keepRows = dat$Status != "In litigation" & dat$Status != "In review" & dat$Status != "Claim has been assigned for further investigation"  & dat$Status != "Claim entered" & dat$Status != "Pending response from claimant" & dat$Status !=  "Closed as a contractor claim" & dat$Status != "Canceled"
dat = dat[keepRows,]
levels(dat$Status)[levels(dat$Status) %in% c('Settled','Settle')] <- 'Settled'
levels(dat$Status)[levels(dat$Status) %in% c('Denied','Deny')] <- 'Denied'

# Make sure all similar variants of Disposition values are consolidated
levels(dat$Disposition)[levels(dat$Disposition) %in% c('Settled','Settle')] <- 'Settled'
levels(dat$Disposition)[levels(dat$Disposition) %in%  c('Denied','Deny')] <- 'Denied'


# If Disposition is "Approve in Full" and Claim.Amount or Close.Amount is not, set the empty amount value to the other or delete row if both empty
new.claim = apply(dat, 1, function(x){
    if (x["Disposition"] == "Approve in Full") {
      if (x["Claim.Amount"] == "" & x["Close.Amount"] != "") {
        x["Claim.Amount"] = x["Close.Amount"]
      }
    }
  x["Claim.Amount"]
})

new.close = apply(dat, 1, function(x){
    if (x["Disposition"] == "Approve in Full") {
      if (x["Claim.Amount"] != "" & x["Close.Amount"] == ""){
        x["Close.Amount"] = x["Claim.Amount"]
      }
    }
  x["Close.Amount"]
})

dat$Claim.Amount = new.claim
dat$Close.Amount = new.close

keepRows = dat$Claim.Amount != "" | dat$Close.Amount != "" | dat$Disposition != "Approve in Full"
dat = dat[keepRows,]

# Delete rows where Status  has value of "-"
keepRows = dat$Status != "-"
dat = dat[keepRows,]


# If Status is "Approve in Full" set it to equal "Approved" and set Close.Amount to equal Claim.Amount and Disposition to equal "Approved"
new.status = apply(dat, 1, function(x){
    if (x["Status"] == "Approve in Full") {
      x["Status"] = "Approved"
    }
  x["Status"]
})

new.disposition = apply(dat, 1, function(x){
    if (x["Status"] == "Approve in Full") {
      x["Disposition"] = "Approve in Full"
    }
  x["Disposition"]
})

new.close = apply(dat, 1, function(x){
    if (x["Status"] == "Approve in Full") {
      x["Close.Amount"] = x["Claim.Amount"]
    }
  x["Close.Amount"]
})

dat$Status = new.status 
dat$Disposition = new.disposition
dat$Close.Amount = new.close


# If Status is "Insufficient..." and Disposition is "Denied", set Status = "Denied" and Close.Amount == "$0.00"
new.status = apply(dat, 1, function(x){
    if (x["Status"] == "Insufficient; one of the following items required: sum certain; statement of fact; signature; location of incident; and date." & x["Disposition"] == "Denied") {
      x["Status"] = "Denied"
    }
  x["Status"]
})

new.close = apply(dat, 1, function(x){
    if (x["Status"] == "Insufficient; one of the following items required: sum certain; statement of fact; signature; location of incident; and date." & x["Disposition"] == "Denied") {
      x["Close.Amount"] = "$0.00"
    }
  x["Close.Amount"]
})

dat$Status = new.status 
dat$Close.Amount = new.close


# If Status is "Insufficient..." and Disposition is "Approve in Full", set Status = "Approved"
new.status = apply(dat, 1, function(x){
    if (x["Status"] == "Insufficient; one of the following items required: sum certain; statement of fact; signature; location of incident; and date." & x["Disposition"] == "Approve in Full") {
      x["Status"] = "Approved"
    }
  x["Status"]
})

dat$Status = new.status 
dat$Status = factor(dat$Status)


# If Status is "Insufficient..." delete rows
keepRows = dat$Status != "Insufficient; one of the following items required: sum certain; statement of fact; signature; location of incident; and date."
dat = dat[keepRows,]


# If Status is "Denied" set Close.Amount = "$0.00"
new.close = apply(dat, 1, function(x){
    if (x["Status"] == "Denied" & x["Close.Amount"] != "$0.00") {
      x["Close.Amount"] = "$0.00"
    }
    if (x["Close.Amount"] == "$0.00 "){
      x["Close.Amount"] == "$0.00"
    }
  x["Close.Amount"]
})

dat$Close.Amount = new.close

# If Status is "Denied" and Close.Amount = "$0.00", set Disposition = "Denied"
new.disposition = apply(dat, 1, function(x){
    if (x["Status"] == "Denied" & x["Close.Amount"] == "$0.00" & x["Disposition"] == "") {
      x["Disposition"] = "Denied"
    }
  x["Disposition"]
})
dat$Disposition = new.disposition

# If Status is Close.Amount = "$0.00 " and Disposition = "Approve in Full" set Close.Amount to equal Claim.Amount
new.close = apply(dat, 1, function(x){
    if (x["Close.Amount"] == "$0.00 " & x["Disposition"] == "Approve in Full") {
      x["Close.Amount"] = x["Claim.Amount"]
    }
  x["Close.Amount"]
})
dat$Close.Amount = new.close

# If Status is "Settled" and Disposition == "" and Close.Amount = "", delete row
keepRows = dat$Status != "Settled" | dat$Disposition != "" | dat$Close.Amount != ""
dat = dat[keepRows,]
dat$Status = factor(dat$Status)


# Delete any final rows with empty values
keepRows = dat$Claim.Amount != ""
dat = dat[keepRows,]

keepRows = dat$Incident.Date != ""
dat = dat[keepRows,]

keepRows = dat$Date.Received != ""
dat = dat[keepRows,]

# Delete unnecessary levels
dat$Disposition = factor(dat$Disposition)
dat$Claim.Number = factor(dat$Claim.Number)
dat$Date.Received = factor(dat$Date.Received)
dat$Incident.Date = factor(dat$Incident.Date)
dat$Airport.Code= factor(dat$Airport.Code)
dat$Airport.Name= factor(dat$Airport.Name)
dat$Airline.Name= factor(dat$Airline.Name)
dat$Claim.Type= factor(dat$Claim.Type)
dat$Claim.Site= factor(dat$Claim.Site)
dat$Item= factor(dat$Item)


# Format Claim.Amount and Close.Amount values
dat$Claim.Amount = gsub(";","",dat$Claim.Amount)
dat$Claim.Amount = gsub("[$]","",dat$Claim.Amount)
dat$Claim.Amount = as.numeric(gsub(" ","",dat$Claim.Amount))

dat$Close.Amount = gsub(";","",dat$Close.Amount)
dat$Close.Amount = gsub("[$]","",dat$Close.Amount)
dat$Close.Amount = as.numeric(gsub(" ","",dat$Close.Amount))

# Delete anomalous Claim.Amount values
keepRows = dat$Claim.Amount < 164500.00
dat = dat[keepRows,]

# Delete remaining rows where Claim.Amount is `0`
keepRows = dat$Claim.Amount > 0
dat = dat[keepRows,]
```

***



## Data exploration and visualization

Our investigation revolves around whether a claim filed with TSA is settled, approved in full, or denied. The initial data exploration looks into the proportion of claims that are denied or not.
Here we can see the majority of claims are denied and at a greater extent than claims being approved in full and settled combined. 
``` {r}
barplot(table(dat$Disposition), col = "red4")
```

***

When plotting the claim amounts and close amounts, we can see that there are some noticeable trends. Of course, there is a strong line along the x-axis at the y value of zero. This indicates the claim amounts that were denied, resulting in a close amount of zero. There is also a line along the diagonal of the plot, indicating claim amounts that were approved in the full amount, so the claim amount value is equal to the final close amount. 

Interestingly, there are some data points where the final close amount is greater than the filed claim amount. This occurence is seen in lower claim amount values and may be due to the fact that some claim amounts were rounded to the nearest dollar when the claims were closed.

``` {r}
plot(dat$Claim.Amount, dat$Close.Amount, xlim = c(0, quantile(dat$Claim.Amount, 0.995)), ylim = c(0, 10000), pch = ".", main = "Claim Amount Values vs. Close Amount", xlab = "Claim Amount Filed", ylab = "Final Close Amount", col = "navy")
```



## Conclusions

```
#test stuff:
dat[dat$Claim.Amount == 0, c("Disposition", "Close.Amount", "Claim.Amount")]
```
